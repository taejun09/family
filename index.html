<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title id="page-title">우리가족 | 생일 축하 페이지</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/toss/tossface/dist/tossface.css" rel="stylesheet" type="text/css" />
  <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg" />
  <link rel="shortcut icon" href="/img/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png" />
  <link rel="manifest" href="/img/site.webmanifest" />

  <style>
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .tossface { font-family: Tossface; font-size: 1.5rem; }
    @font-face {
      font-family: 'IM_Hyemin-Bold';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2106@1.1/IM_Hyemin-Bold.woff2') format('woff');
      font-weight: normal; font-style: normal;
    }
    html, body {
      font-size: 18px;
      font-family: IM_Hyemin-Bold;
      height: 100%; margin: 0; padding: 0;
    }
    body {
      background-image: radial-gradient(circle, #fff7f0 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .balloon {
      position: absolute; animation: float 6s ease-in-out infinite;
      font-size: 2rem; z-index: 0;
    }
    @keyframes float {
      0% { transform: translateY(100vh) translateX(0); opacity: 0; }
      30% { opacity: 1; }
      100% { transform: translateY(-20vh) translateX(20px); opacity: 0; }
    }
  </style>
</head>
<body class="min-h-full p-6 flex flex-col items-center text-gray-800 relative">

  <!-- 🎈 풍선 애니메이션 -->
  <div class="balloon left-[10%] delay-[0s]"><span class="tossface text-4xl">🎈</span></div>
  <div class="balloon left-[40%] delay-[1s]"><span class="tossface">🎈</span></div>
  <div class="balloon left-[70%] delay-[2s]"><span class="tossface">🎈</span></div>

  <!-- 🎵 배경음악 -->
  <audio id="bg-music" autoplay muted loop>
    <source src="/happy-birthday-357371.mp3" type="audio/mpeg">
    브라우저가 오디오를 지원하지 않습니다.
  </audio>

  <h2 class="text-xl sm:text-2xl text-gray-600 mb-2 text-center">오늘은 누구의 생일일까요?</h2>
  <h1 id="celebration-message" class="text-3xl sm:text-4xl font-semibold text-pink-600 mb-4 hidden text-center"></h1>

  <div class="w-full max-w-2xl space-y-6 z-10" id="card-list"></div>

  <div class="h-24"></div>

  <footer class="w-full mt-12 pt-8 border-t text-center text-sm text-gray-500">
    <p class="mb-1">🎂 함께여서 더 행복한 우리 가족 🎂</p>
    <p class="mb-2">© 2025 KIM TAEJUN All rights reserved.</p>
    <p class="text-xs text-gray-400">made with 💛 by Family and KIM TAEJUN</p>
  </footer>

  <!-- ✅ 자체 팝업 -->
  <div id="app-popup" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative bg-white rounded-2xl shadow-xl max-w-md w-[90%] p-6 text-center">
      <h3 id="popup-title" class="text-2xl font-semibold mb-2">알림</h3>
      <p id="popup-message" class="text-gray-700 leading-relaxed">메시지</p>
      <button id="popup-close" class="mt-6 px-5 py-2.5 rounded-full bg-pink-500 hover:bg-pink-600 text-white font-medium w-full">확인</button>
    </div>
  </div>

  <script>
    // ===== 설정 =====
    const PASSWORD = '96510';
    const STORAGE_KEY = 'birthdayPageLastAccess';
    const ACCESS_DURATION = 7 * 24 * 60 * 60 * 1000;
    const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1408447744971898951/nhjFUcbV9J7CT_raMgZQnHJ05Vk9IicVEvhLBxlIoEUS_geyw8ddW664t7zykNOmDwar';

    // ===== 유틸: 팝업 =====
    function showPopup(title, message) {
      const popup = document.getElementById('app-popup');
      document.getElementById('popup-title').textContent = title;
      document.getElementById('popup-message').textContent = message;
      popup.classList.remove('hidden');
      popup.classList.add('flex');
    }
    function hidePopup() {
      const popup = document.getElementById('app-popup');
      popup.classList.add('hidden');
      popup.classList.remove('flex');
    }
    document.getElementById('popup-close').addEventListener('click', hidePopup);

    // ===== 접근 제어 =====
    function isAccessValid() {
      const lastAccess = localStorage.getItem(STORAGE_KEY);
      if (!lastAccess) return false;
      const lastTime = parseInt(lastAccess, 10);
      return (Date.now() - lastTime) < ACCESS_DURATION;
    }

    async function askPassword() {
      return new Promise((resolve) => {
        let attempts = 3;
        function promptPassword() {
          const input = prompt('비밀번호를 입력하세요 (3회 기회)');
          if (input === null) { resolve(false); return; }
          if (input === PASSWORD) { resolve(true); }
          else {
            attempts--;
            if (attempts > 0) {
              alert(`비밀번호가 틀렸습니다. ${attempts}회 남음.`);
              promptPassword();
            } else {
              alert('비밀번호 입력 횟수를 초과했습니다.');
              resolve(false);
            }
          }
        }
        promptPassword();
      });
    }

    async function checkAccess() {
      if (isAccessValid()) {
        initPage();
      } else {
        const ok = await askPassword();
        if (ok) {
          localStorage.setItem(STORAGE_KEY, Date.now().toString());
          initPage();
        } else {
          document.body.innerHTML = '<h2 class="text-center mt-20 text-xl text-red-600">접근 권한이 없습니다.</h2>';
        }
      }
    }

    // ===== 디스코드 웹훅 전송 =====
    async function sendGiftRequestToDiscord(name) {
  const payload = {
    username: 'Birthday Bot',
    content: `<@1401891737642733679>`,
    embeds: [{
      title: '🎁 선물 발송 요청',
      description: `1일 이내 ${name}님께 선물을 발송해주세요.`,
      color: 16750848,
      timestamp: new Date().toISOString(),
      footer: { text: '우리가족 생일 페이지' }
    }],
    allowed_mentions: { users: ["1401891737642733679"] }
  };

  const res = await fetch(DISCORD_WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const text = await res.text().catch(()=> '');
    throw new Error(`Webhook 실패 (${res.status}) ${text}`);
  }
}

    function initPage() {
      const birthdays = {
        '김규현': '09-13',
        '송인정': '06-03',
        '김태준': '05-27',
        '김주영': '10-01'
      };

      const today = new Date();
      const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const cardList = document.getElementById('card-list');

      let birthdayTitleName = null;

      Object.entries(birthdays).forEach(([name, dateStr]) => {
        const [month, day] = dateStr.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), month - 1, day);

        let diffDays = Math.ceil((birthdayThisYear - todayDate) / (1000 * 60 * 60 * 24));
        let ddayText = '';
        let isToday = false;

        if (diffDays === 0) {
          ddayText = 'D-DAY 입니다!';
          isToday = true;
          birthdayTitleName = name;
        } else if (diffDays < 0) {
          ddayText = '생일이 지났어요!';
        } else {
          ddayText = `생일까지 D-${diffDays} 남았어요!`;
        }

        const card = document.createElement('div');
        card.className = `rounded-2xl shadow p-8 flex items-center justify-between border transition-all duration-300 ${
          isToday ? 'bg-pink-100 border-pink-200' : 'bg-gray-200 border-gray-300'
        }`;

        card.innerHTML = `
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between w-full gap-2 sm:gap-0">
            <div>
              <p class="text-2xl font-semibold">${name}</p>
              <p class="text-lg text-gray-600 mt-1">${ddayText}</p>
            </div>
            <a
              href="#"
              class="gift-btn mt-2 sm:mt-0 px-5 py-3 rounded-full text-base font-medium transition text-center w-full sm:w-auto ${
                isToday ? 'bg-pink-400 hover:bg-pink-500 text-white' : 'bg-gray-400 text-white pointer-events-none'
              }"
              ${isToday ? '' : 'aria-disabled="true"'}
              data-name="${name}"
            >
              선물과 편지 확인하기
            </a>
          </div>
        `;
        cardList.appendChild(card);

        // 오늘 생일인 경우 클릭 핸들러 부여
        if (isToday) {
          const btn = card.querySelector('.gift-btn');
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (btn.dataset.loading === '1') return; // 중복 방지
            btn.dataset.loading = '1';
            btn.textContent = '요청 전송 중...';
            btn.classList.add('opacity-70', 'pointer-events-none');

            try {
              await sendGiftRequestToDiscord(name);

              // 성공 팝업
              showPopup(
                '요청이 전송되었어요! 🎉',
                '24시간 안에 선물을 받아 볼 수 있을 거예요!'
              );

              // 버튼 상태 고정
              btn.textContent = '요청 완료';
            } catch (err) {
              console.error(err);
              // 실패 팝업
              showPopup(
                '전송에 실패했어요 😢',
                '잠시 후 다시 시도해 주세요.'
              );
              // 재시도 가능하도록 복구
              btn.dataset.loading = '0';
              btn.textContent = '선물과 편지 확인하기';
              btn.classList.remove('opacity-70', 'pointer-events-none');
            }
          });

          // 축포
          confetti({ particleCount: 200, spread: 160, origin: { y: 0.3 } });
        }
      });

      if (birthdayTitleName) {
        document.title = `우리가족 | To. ${birthdayTitleName}`;
        const messageElement = document.getElementById('celebration-message');
        messageElement.innerHTML = `${birthdayTitleName}님의 생일을 진심으로 축하해요! <span class="tossface">🎉</span>`;
        messageElement.classList.remove('hidden');
      }

      // 오디오 자동 재생 허용
      window.addEventListener('DOMContentLoaded', () => {
        const music = document.getElementById('bg-music');
        music.muted = false;
        const playPromise = music.play();
        if (playPromise !== undefined) {
          playPromise.catch(() => {
            const playAudio = () => {
              music.muted = false;
              music.play().catch(() => {});
              document.removeEventListener('click', playAudio);
            };
            document.addEventListener('click', playAudio);
          });
        }
      });
    }

    checkAccess();
  </script>

  <script>
    document.addEventListener('dragstart', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
  </script>


<script>
  // 리디렉트 주소
  const redirectURL = "https://example.com";

  // 우클릭 방지
  document.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    location.href = redirectURL;
  });

  // F12 (개발자 도구 열기) 감지
  window.addEventListener("keydown", (e) => {
    if (
      e.key === "F12" || 
      (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
      (e.ctrlKey && e.key === "U")
    ) {
      location.href = redirectURL;
    }
  });

  // 개발자 도구 열기 감지 (크기 차이 활용)
  const devtoolsChecker = setInterval(() => {
    if (window.outerWidth - window.innerWidth > 160 || window.outerHeight - window.innerHeight > 160) {
      location.href = redirectURL;
    }
  }, 1000);

  // PC 환경에서 창 크기 변경 감지 (최초 너비 기억 → 변경되면 리다이렉트)
  let initialWidth = window.innerWidth;
  window.addEventListener("resize", () => {
    const isPC = window.innerWidth > 768;
    if (isPC && window.innerWidth !== initialWidth) {
      location.href = redirectURL;
    }
  });
</script>
</body>
</html>